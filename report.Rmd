---
title: "U Up? Sleep and GPA of First-Year College Students"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

Group Members: Kate Colvin (kac2301), Yuying Lu (yl5839), and Chhiring Lama (cyl2159)

--- 

```{r, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(tidyverse)
library(gtsummary)
library(ggpubr)
library(patchwork)
library(kableExtra)
library(plotly)
library(ggplot2)
library(broom)
library(knitr)

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{css, echo = FALSE}
tr:hover {background-color: coral;}
th {
  height: 5px;
}
```


## Motivation

Student lack of success and under-performance in college is a large waste of human capital and money. It is widely known that student academic success depends on a number of factors, including regular sleep habits. Our goal in this study is to better understand how first-year GPA is impacted by sleeping behavior, while controlling for multiple demographic factors across three distinct universities. Additionally, understanding how demographic factors are related to sleeping behavior can provide guidance to universities on how to allocate resources to student behavioral health initiatives to best improve student success. 

Finally, as previous undergraduates, current graduate students, and potentially future educators, understanding how sleeping behavior impacts academic performance is a personally compelling topic.

---

## Related Work

The data for our project came from a 2023 study, ["Nightly sleep duration predicts grade point average in the first year of college" ](https://www.pnas.org/doi/10.1073/pnas.2209123120), by JD Creswell et al. In this study, they found that term GPA and total sleep time were positively associated. Their multiple regression analysis controlled for daytime sleep, demographic variables, and standardized course load. All previous studies on this topic relied on self-reported recollections of total sleep time, which is prone to recall bias, and excludes other potentially important measures of sleep behavior. 

Our project aimed to expand upon the study conducted by JD Creswell et al in several ways: to further explore the distributions of and correlations between the demographic, academic, and sleep behavior variables they collected; improve upon the models they used to predict GPA; and to use a linear regression model combined with bootstrapping to increase model accuracy. 

---

## Initial Questions

Initially, our proposed project was to study how the lifestyle habits of college students impacted their duration and quality of sleep. As we researched further into this topic, we found a greater amount of real-world data available covering sleeping behavior and academic performance, which pushed us to instead look at sleeping behavior as a predictor of GPA. 

Our primary questions heading into this project were: 

* Q1: How are course load and GPA distributed in different gender, race, educational background and colleges?
* Q2: What are the main sleeping patterns seen in students over multiple measures of sleeping behavior? 
* Q3: What can we learn about the relationship between academic performance, demographic characteristics, and sleeping habits in first-year college students? Can academic performance be predicted using these variables?

As we explored the data further, several additional questions came up regarding the variables relationships with each other and how the structure of the study may impact our results: 

* Q4: How is course load related to GPA overall, and in various demographic sub-groups?
* Q5: How are different sleeping behaviors related to each other? How will this inform our regression models? 
* Q6: How important are the characteristic differences of the three universities recruited in this study (Carnegie Mellon, Notre Dame, and University of Washington)? Will this change the impact of demographic and sleeping variables on the GPA?

---

## Data

We found our data from the [Carnegie Mellon University Statistics and Data Science Data Repository](https://cmustatistics.github.io/data-repository/). This data was originally collected from 2016-2019 for the [2023 study](https://www.pnas.org/doi/10.1073/pnas.2209123120) described in our "Related Work" section above. For this study, they recruited first-year students from three distinct American universities, Carnegie Mellon University, The University of Washington, and Notre Dame University. Data on sleeping behavior was collected from FitBits that were given to recruited students, and demographic and academic data was collected directly from the universities. 

More information on how data collection was conducted and the final data set itself can be found on [this page](https://cmustatistics.github.io/data-repository/psychology/cmu-sleep.html). 

```{r, message=FALSE}
sleep_df <- read_csv("data/cmu-sleep.csv") |> 
  janitor::clean_names() |> 
  mutate(demo_race = case_when(demo_race == 0 ~ "Underrepresented", 
                                     demo_race == 1 ~ "Non-underrepresented"),
         demo_race = fct_relevel(demo_race, "Non-underrepresented"),
         demo_gender = case_when(demo_gender == 0 ~ "Male", 
                                     demo_gender == 1 ~ "Female"),
         demo_gender = fct_relevel(demo_gender, "Male"), 
         demo_firstgen = case_when(demo_firstgen == "0" ~ "Non-first gen", 
                                   demo_firstgen == "1" ~ "First-gen", 
                                   TRUE ~ NA),
         demo_firstgen = fct_relevel(demo_firstgen, "Non-first gen"), 
         time_collection = case_when(cohort == "lac1" ~ "Spring, 2018", 
                            cohort == "lac2" ~ "Spring, 2017",
                            cohort == "nh" ~ "Spring, 2016",
                            cohort == "uw1" ~ "Spring, 2018", 
                            cohort == "uw2" ~ "Spring, 2019"), 
         university = case_when(cohort == "lac1" ~ "CMU", 
                            cohort == "lac2" ~ "CMU",
                            cohort == "nh" ~ "NDU",
                            cohort == "uw1" ~ "UW", 
                            cohort == "uw2" ~ "UW"))
```

For the exploratory analyses, we utilized the full data set, which contains 634 students. Cleaning the data involved several steps. First, all demographic variables (race, gender, and first-generation status) were encoded in 0s and 1s, so we used the data dictionary to replace the values in these columns with the correct labels. Next, we created two new variables to help us explore different sub-groups of the data set: 

* `university`:	Out of the three university,`NDU = Notre Dame University`, `CMU = Carnegie Mellon University` and `UW = University of Washington`. This information is derived from `study` variable as `1` and `5` were from Carnegie Mellon University, `2` and `3` from University of Washington, and `4` from Notre Dame University. 
* `time_collection`: It refers to the time of data collection, derived from `study` variable. The value `4` in `study` was is for `Spring 2016`, `5` for `Spring 2017`, `1`, `2` for `Spring 2018`, and `3` for `Spring 2019`.

We also noticed that there were several variables with a handful of missing values. There are less than 5 missing entries for each of our demographic variables, but notably, we are missing all course load information (`term_units`, `zterm_units_zof_z`) for students recruited from Notre Dame, which make up 147 of our 634 total observations. Rows with these missing values were removed when course load information was required for our exploratory analyses, and course load information variables were not included in our statistical analysis.

Further data wrangling are done before we fit linear regression models in statistical analysis. The time-related data `total_sleep_time`, `midpoint_sleep` and `daytime_sleep` being recorded in minutes are transformed into hour form. Additionally, the `bedtime_mssd` that mainly distributed round $0^+$ are replaced by a log-transformed value log(`bedtime_mssd`+1). These transformations shrink the difference in the range scale of the variables.

---

## Exploratory Analysis  

Our exploratory analysis is broken into two main sections: [student characteristics](students.html) and [sleeping patterns](sleep_metrics.html). 

### Exploratory Analysis: Students {.tabset}
```{r, message=FALSE,warning=FALSE}
student_sleep_df <- sleep_df |> 
  rename(`University` =`university`, 
         `Race` =`demo_race`, 
         `Gender` =`demo_gender`, 
         `First-Generation` =`demo_firstgen`, 
         `Relative Course Load`= `zterm_units_zof_z`, 
         `End-of-term GPA` =  `term_gpa`, 
         `Cumulative GPA` = `cum_gpa`)

plot_gpa <- function(demo, gpa, var_equal, comp) {
  subset_df <- student_sleep_df |> 
    drop_na(rlang::sym(demo), rlang::sym(gpa)) 
  
  max_y <- max(subset_df[,gpa], na.rm = TRUE)
  
  y_positions <- seq(max_y, by = 0.5, length.out = length(comp))
  
  cols <- c("End-of-term GPA" = "#ffaaaa", 
            "Cumulative GPA" = "#ffddba")
  
  subset_df |> 
    ggplot(aes(x = get(demo), y = get(gpa), fill = gpa)) +
    geom_violin(alpha = 0.2) + 
    labs(y = "", x = "", fill = "") +
    scale_y_continuous(expand = c(0,0), limits = c(min(subset_df[,gpa]), max(y_positions) + 0.5)) +
    #facet_wrap(~academic_info, ncol = 3, scales = "free") +
    theme(panel.spacing = unit(1, "lines")) +
    scale_fill_manual(values = cols) +
    stat_compare_means(aes(label = paste0("p = ", p.format)), method = "t.test", 
                       paired = FALSE, comparisons = comp,
                       method.args = list(var.equal = var_equal), 
                       p.adjust.method = "bonferroni", 
                       label.y = y_positions) +
    stat_summary(fun = "median", fun.min = "median", color = "skyblue", 
                 fun.max= "median", size= 0.2, geom = "crossbar") 
}
```
All of the graphs and analyses mentioned in this segment can be found on our [Students](students.html) page. Among students from different universities, proportion of underrepresented students were not significantly different. 

Our analysis of course load and GPA data provided valuable insights into the relationship between demographics and academic performance. First, we observed no significant differences in course load across various demographic groups, as measured by an independent t-test. Mean relative course load is near 0, meaning they have average course load. This indicates that students from different demographic backgrounds and universities generally maintained similar course loads. However, we did find that students from underrepresented racial groups had significantly lower GPAs compared to their well-represented peers (independent t-test, p = 0.0022). Additionally, first-generation students exhibited lower term GPAs than their non-first-generation counterparts (p = 0.00069). Notably, students from NDU had higher GPAs than those from CMU (p = 1.6e-11) and UW (p = 4.8e-11). The term and cumulative GPAs' distribution are both negatively-skewed. Median GPAs are between 3 to 4, variable within this range for different groups. 

#### Race {.tabset}

```{r, fig.width = 7, fig.height = 4, out.width = "80%", dpi=600,message=FALSE,warning=FALSE}
demo_name = "Race"
comp = list(c("Underrepresented", "Non-underrepresented"))
plot_gpa(demo = demo_name, "End-of-term GPA", FALSE, comp) +
  plot_gpa(demo = demo_name, "Cumulative GPA", FALSE, comp)
```

#### Gender {.tabset}

```{r, fig.width = 7, fig.height = 4, out.width = "80%", dpi=600,message=FALSE,warning=FALSE}
demo_name = "Gender"
comp <- list(c("Male", "Female"))
plot_gpa(demo = demo_name, "End-of-term GPA", TRUE, comp) +
  plot_gpa(demo = demo_name, "Cumulative GPA", TRUE, comp)
```

#### First-Generation {.tabset}

```{r, fig.width = 7, fig.height = 4, out.width = "80%", dpi=600,message=FALSE,warning=FALSE}
demo_name = "First-Generation"
comp <- list(c("Non-first gen", "First-gen"))
plot_gpa(demo = demo_name, "End-of-term GPA", TRUE, comp) +
  plot_gpa(demo = demo_name, "Cumulative GPA", TRUE, comp)
```

#### University {.tabset}

```{r, fig.width = 7, fig.height = 4, out.width = "80%", dpi=600,message=FALSE,warning=FALSE}
demo_name = "University"
comp = list(c("CMU", "NDU"), c("NDU", "UW"), c("CMU", "UW"))
plot_gpa(demo = demo_name, "End-of-term GPA", FALSE, comp) +
  plot_gpa(demo = demo_name, "Cumulative GPA", FALSE, comp)
```

We used multiple linear regression to model relative effects of demographics and course load on term GPA. After controlling for race, gender, university, and first-generation college status, course load was found to have no significant effect on GPA (p = 0.133). Given that course load did not vary significantly across student groups, did not show a meaningful association with term GPA, and that Notre Dame University (NDU) lacked relevant data on course load, we excluded this variable from our final statistical analyses.

### {.tabset}

We found that underrepresented students had GPAs 0.72 points lower than their peers from well-represented racial backgrounds, suggesting that race may be a critical predictor of GPA outcomes (p = 1.08e-05). However, first-generation college status did not have a direct effect on GPA once the interplay with other factors was accounted for. Further analysis revealed that first-generation students in our study were disproportionately from underrepresented racial backgrounds and were predominantly enrolled at the University of Washington (UW) (See *Appendix B* in [student data](students.html)). This concentration may help explain the initial GPA differences observed among first-generation students before adjusting for these overlapping factors. 

We examined whether students' GPAs improved within individual demographic groups. Interestingly, the changes were minimal and not statistically significant (See Section *Improvement in GPA* in [student data](students.html)). This was true across all groups, indicating that the term GPA did not vary significantly from cumulative GPA during their first year. 

#### Coefficient Estimate {.tabset}
```{r, fig.width = 7, fig.height = 4, out.width = "80%", dpi=600,message=FALSE,warning=FALSE}
model <- lm(`End-of-term GPA` ~ `Relative Course Load`*Race +
     `Relative Course Load`*`Gender` +
     `Relative Course Load`*`First-Generation` +
     `Relative Course Load`*`University`, 
                data = student_sleep_df) 

res <- bind_cols(broom::tidy(model), confint(model, level = 0.95))|> 
  mutate(term= str_replace(term, "RaceUnderrepresented", "Race - Underrepresented"), 
         term= str_replace(term, "GenderFemale", "Gender - Female"), 
         term= str_replace(term, "`First-Generation`First-gen", "First-gen"), 
         term= str_replace(term, "UniversityUW", "University - UW")) |> 
  select(term, estimate, `2.5 %`, `97.5 %`) |> 
  filter(term != "(Intercept)")

res |> 
  mutate(term = fct_reorder(term, estimate, sort)) |>
  ggplot(aes(x = term, y = estimate)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "grey") +
  geom_errorbar(aes(ymin = `2.5 %`, ymax = `97.5 %`),color = "darkred", width = 0.5)+
  geom_point(size = 2, shape = 21, fill = "white") +
  theme(plot.title = element_text(size = 10, face = "bold"), 
        axis.title = element_text(size = 9, face = "bold")) +
  labs(y = "Coefficient", x = "Predictor",
       title = "Coefficient Estimate (w/ 95% CI)", color = "") +
  coord_flip()
```

#### Statistics {.tabset}
```{r}
model |> 
  broom::tidy() |> 
  mutate(term= str_replace(term, "RaceUnderrepresented", "Race - Underrepresented"), 
         term= str_replace(term, "GenderFemale", "Gender - Female"), 
         term= str_replace(term, "`First-Generation`First-gen", "First-gen"), 
         term= str_replace(term, "UniversityUW", "University - UW")) |> 
  rename(`SE` = `std.error`) |> 
  mutate(estimate = round(`estimate`, digits = 3), 
         `SE` = round(`SE`, digits = 3), 
         statistic = round(`statistic`, digits = 3)) |> 
  mutate(`p.value` = signif(`p.value`, digits = 3)) |> 
  knitr::kable(digits = 170) |> 
  row_spec(2, background = "darkgrey") |> 
  kable_minimal()
```

---

### Exploratory Analysis: Sleep {.tabset}

All of the graphs mentioned in this segment and further in-depth explanations can be found on our [Sleeping Patterns](sleep_metrics.html) page.

At the bottom of this section are plots of the overall distributions of each of the four sleep metrics, stratified by university. Two of the metrics, "Total Sleep Time" and "Sleeping Midpoint", are roughly normally distributed. The two other metrics, "Variability in Sleep Time" and "Daytime Sleep" are both very right skewed distributions. For all metrics, distributions are very similar between each university, but for each metric, at least one university is statistically significantly distinct from the others (see the "Statistics" tab below).

To look at the relationships between these metrics, we constructed a Pearson correlation coefficient table that indicates that several of the sleep behavior variables are correlated with each other. First, sleeping midpoint and bedtime variability are positively correlated (0.41), which makes sense, since more sporadic sleeping schedules are commonly explained by staying up late. Additionally, total sleep time has a moderate negative correlation with daytime sleep (-0.29) and sleeping midpoint (-0.33). This also makes sense, as we expect that longer nighttime sleep would lead to less time sleeping during the day and likely an earlier bedtime. These relationships helped informed our regression analyses, which is discussed below in the "Statistical Analysis" portion. 

Interesting patterns were also found between these metrics and the demographic and academic variables included in this data set. On a heat map of GPA and course load, we found that "Total Sleep Time" increased with greater GPAs and decreased with greater course loads, and that "Sleeping Midpoint" became earlier as GPA increased. These findings were expected results, as we initially thought that less sleep and later sleeping midpoints may lead to insufficient and low quality of sleep, making students too tired to study well in the daytime. 

Between different gender, race, and first-generation statuses, minimal differences were found between sleeping behaviors. "Sleeping Midpoint" and "Daytime Sleep" were the only variables with statistically significantly different medians. For gender, we found that men tended to have later sleeping midpoints (a pattern found within each of the three universities individually), and that students of underrepresented races or who were first-generation tended to have greater daytime sleep. 

Again, please see the [Sleeping Patterns](sleep_metrics.html) page for all of the data visualizations that go along with these results. 

#### Total Sleep Time {.tabset}

```{r}
plot_totalsleep <- sleep_df %>%  
  ggplot(aes(x = total_sleep_time, fill = university, color = university)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Total Sleep Time (minutes)", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )

plot_totalsleep    
                          
```

---

#### Variability in Bed Times {.tabset}

```{r, warning=FALSE}
plot_bedtime2 <- sleep_df %>%  
  ggplot(aes(x = bedtime_mssd, fill = university, color = university)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Mean Successive Squared Difference", y = "Density") +
  xlim(c(0,2.5))+
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )

plot_bedtime2

```

--- 

#### Sleeping Midpoint {.tabset}

```{r}
plot_midpoint <- sleep_df %>% 
  ggplot(aes(x = midpoint_sleep, fill = university, color = university)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Midpoint Sleep (minutes past 11 PM)", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )

plot_midpoint

```

--- 

#### Daytime Sleep {.tabset}

```{r}
plot_daysleep <- sleep_df %>% 
  ggplot(aes(x = daytime_sleep, fill = university, color = university)) +
  geom_density(alpha = 0.3, linewidth = 1) +
  labs(x = "Daytime Sleep (minutes)", y = "Density") +
  theme_minimal() +
  theme(
    strip.text = element_text(size = 14),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )

plot_daysleep

```

---

#### Statistics {.tabset}

```{r}
sleep_df %>% select(total_sleep_time, bedtime_mssd, 
                    midpoint_sleep, daytime_sleep, university) %>% 
  tbl_summary(
    by = university,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} / {N} ({p}%)")) %>% 
    add_p() %>% 
    add_overall()
```

---

## Statitical Analysis

All of the graphs mentioned in this segment and further in-depth explanations can be found on our [Statistical Analysis](statistic_analysis.html) page.

To get a deeper glimpse into the relationship between academic performance, demographic characteristics, and sleeping habits in first-year college students, we considered fitting GPA prediction models based on the characteristic and sleeping measure variables.

We first demonstrated the individual impact of each sleeping measure on students' term GPA by fitting simple linear regression model based on the pooled data, which included observations from three universities. Each time we used one sleeping measure as the predictor to predict the `term_gpa`.  

The result shows that the `total_sleep_time` (see tab *Total Sleep Time*) variable has positive correlation with `term gpa` while the other three variables -- `bedtime_mssd`(see tab *Variability in Bed Times*), `midpoint_sleep`(see tab *Sleep Midpoint*) and `daytime_sleep`(see tab *Daytime Sleep*) are negative related with `term_gpa`. We also collected the p-value and the Mean Squared Error (MSE) from each simple linear regression model(see tab *Comparison*). All of the sleeping measures have significantly non-zero coefficient when used as the only predictor to predict term GPA. Among them, the simple linear regression has the smallest MSE when using the variable `total_sleep_time`.

Next we applied multiple linear regression model that includes more than one variable at a time. We first included  (**Sleeping Measures Only Model**) focus on linear model that includes all of the 4 sleeping measures as predictors without considering other factors that may have impact on term GPA. The second part (**Characteristic-Included Model**) were about the linear model that included other informative characteristics of students as the predictors. For each part, we applied linear regression on the initial data set (labeled as *Initial*) and 1000 times bootstrapped data set (labeled as *Bootstrap*). 

**Sleeping Measures Only Model**

```{r, include=FALSE}
sleep_df <- read_csv("data/cmu-sleep.csv") %>% 
  janitor::clean_names() %>%  
  mutate(demo_race = case_when(demo_race == 0 ~ "Underrepresented", 
                                     demo_race == 1 ~ "Non-underrepresented"),
         demo_race = fct_relevel(demo_race, "Underrepresented"),
         demo_gender = case_when(demo_gender == 0 ~ "Male", 
                                     demo_gender == 1 ~ "Female"),
         demo_gender = fct_relevel(demo_gender, "Male"), 
         demo_firstgen = case_when(demo_firstgen == "0" ~ "Non-first gen", 
                                   demo_firstgen == "1" ~ "First-gen", 
                                   TRUE ~ NA),
         demo_firstgen = fct_relevel(demo_firstgen, "Non-first gen"), 
         time_collection = case_when(cohort == "lac1" ~ "Spring, 2018", 
                            cohort == "lac2" ~ "Spring, 2017",
                            cohort == "nh" ~ "Spring, 2016",
                            cohort == "uw1" ~ "Spring, 2018", 
                            cohort == "uw2" ~ "Spring, 2019"), 
         university = case_when(cohort == "lac1" ~ "CMU", 
                            cohort == "lac2" ~ "CMU",
                            cohort == "nh" ~ "NDU",
                            cohort == "uw1" ~ "UW", 
                            cohort == "uw2" ~ "UW")) |> 
  mutate(total_sleep_time = total_sleep_time / 60,
         bedtime_mssd = log(bedtime_mssd+1),
         midpoint_sleep = midpoint_sleep / 60,
         daytime_sleep =  daytime_sleep / 60)

```

```{r}
set.seed(100)
lm_fit = lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = sleep_df)

lm_result =
  broom::tidy(lm_fit,conf.int = TRUE) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(Method = 'Linear Regression')|> 
  mutate(term = reorder(term, estimate))

boot_straps = 
  sleep_df|> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result = 
  boot_straps |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(Method = 'Bootstrap',
         estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high,Method)|> 
  mutate(term = reorder(term, estimate))
  

com_coef =
  rbind(lm_result,boot_result) |> 
  filter(term != "(Intercept)") 

plot_coef = 
  com_coef |>   
  ggplot(aes(x = term, estimate, y = estimate, color = Method)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.3)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

plot_coef

```


When including only 4 sleeping measure variables as the predictors, the linear regression model based either initial data or the bootstrapped data have significant variables `total_sleep_time` and `midpoint_sleep`. However, for the model based on initial data, the coefficient of `daytime_sleep` is also significant non-zero. The numeric result of the estimated coefficient can be found in the page [Statistical Analysis](statistic_analysis.html).

**Characteristic-Included Model**

```{r}
set.seed(100)
lm_fit = lm(term_gpa ~ university + demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = sleep_df)

lm_result =
  broom::tidy(lm_fit,conf.int = TRUE) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(Method = 'Linear Regression')|> 
  mutate(term = reorder(term, estimate))

boot_straps = 
  sleep_df|> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ university + demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result = 
  boot_straps |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(Method = 'Bootstrap',
         estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high,Method) |> 
  mutate(term = reorder(term, estimate))
  

com_coef =
  rbind(lm_result,boot_result) |> 
  filter(term != "(Intercept)") 

plot_coef = 
  com_coef |>   
  ggplot(aes(x = term, y = estimate, color = Method)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.7)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

plot_coef


```

According to the regression result, the variable `cum_gpa`, `universityNDU`, `total_sleep_time` are significantly non-zero, which means it has great impact on `term_gpa`. It makes sense since the `cum_gpa` reflects the students academic background before the studied term, which is crucial to the students' performance in a new term. Additionally, different universities have different academic atmosphere and also follows different grading patterns for students' study performance, leading to distinct `term_gpa` even when other variables are the same. Besides, the larger `total_sleep_time` have potential to improve students' study performance, which implies getting a good sleep is helpful in increasing the GPA. The numeric result of the estimated coefficient can be found in the page [Statistical Analysis](statistic_analysis.html).

Since the `university` variable has significant impact on the `term_gpa` accorrding to characteristic-included linear regression model, we further explored the how the impact of different predictors on the `term_gpa` shift between universities. 

### {.tabset}

**Sleeping Measures Impact**

The following figures show the individual impact of each sleeping measure within different universities. Each line in the plot represents a simple linear regression model for a specific university.  

#### Total Sleep Time {.tabset}

```{r}
plot_uni = 
  ggplot(sleep_df, aes(x = total_sleep_time, y = term_gpa)) +
  geom_point(alpha = 0.6, color = "#664785") +
  geom_smooth(method = "lm", se = FALSE, aes(color = university),alpha = 0.5) +
  labs(
    title = "University Specific Simple Linear Regression",
    x = "Total Sleep Time (Hours)",
    y = "Term GPA"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(plot_uni)

```

--- 

#### Variability in Bed Times {.tabset}


```{r}
plot_uni = 
  ggplot(sleep_df, aes(x = bedtime_mssd, y = term_gpa)) +
  geom_point(alpha = 0.6, color = "#664785") +
  geom_smooth(method = "lm", se = FALSE, aes(color = university),alpha = 0.5) +
  labs(
    title = "University Specific Simple Linear Regression",
    x = "Mean Successive Squared Difference",
    y = "Term GPA"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(plot_uni)
```


--- 


#### Sleeping Midpoint {.tabset}


```{r}
plot_uni = 
  ggplot(sleep_df, aes(x = midpoint_sleep, y = term_gpa)) +
  geom_point(alpha = 0.6, color = "#664785") +
  geom_smooth(method = "lm", se = FALSE, aes(color = university),alpha = 0.5) +
  labs(
    title = "University Specific Simple Linear Regression",
    x = "Midpoint Sleep (hrs past 11 PM)",
    y = "Term GPA"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(plot_uni)
```

--- 

#### Daytime Sleep {.tabset}


```{r}
plot_uni = 
  ggplot(sleep_df, aes(x = daytime_sleep, y = term_gpa)) +
  geom_point(alpha = 0.6, color = "#664785") +
  geom_smooth(method = "lm", se = FALSE, aes(color = university),alpha = 0.5) +
  labs(
    title = "University Specific Simple Linear Regression",
    x = "Daytime Sleep (h)",
    y = "Term GPA"
  ) +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
ggplotly(plot_uni)
```



### {.tabset}

We also fitted the multiple linear regression model for each university and we considered both the sleeping measure only model and characteristic-included model. Besides, when we separated the data into three sub dataset by university for university specific model fitting, the number of the sample size decreases. To ensure good performance of linear model, we only consider the model fitting with bootstrapping. For each university, we bootstrapped the corresponding sub data for 1000 times and applied the linear regression. 


**Sleep Measure Only Model**

```{r}
set.seed(100)

boot_straps_cmu = 
  sleep_df|> 
  filter(university == "CMU") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_cmu = 
  boot_straps_cmu |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'CMU')|>
  filter(term != "(Intercept)") 


boot_straps_ndu = 
  sleep_df|> 
  filter(university == "NDU") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_ndu = 
  boot_straps_ndu |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'NDU')|>
  filter(term != "(Intercept)") 


boot_straps_uw = 
  sleep_df|> 
  filter(university == "UW") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_uw = 
  boot_straps_uw |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'UW')|>
  filter(term != "(Intercept)") 


uni_coef = rbind(boot_result_cmu,
                 boot_result_ndu,
                 boot_result_uw) |> 
  mutate(university = factor(university, levels = c("CMU", "NDU", "UW"))) 

uni_coef |> 
  ggplot(aes(x = term, y = estimate, color = university)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.7)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

```


As we can see from the coefficient estimation result, there's different patterns of how sleeping measures affect the students' term GPA. `total_sleep_time` is significant for both NDU and UW. More detailed result can be found on our page [Statistical Analysis](statistic_analysis.html).


**Characteristics-Included Model**

```{r}
set.seed(100)

boot_straps_cmu = 
  sleep_df|> 
  filter(university == "CMU") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_cmu = 
  boot_straps_cmu |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'CMU')|> 
  filter(term != "(Intercept)")


boot_straps_ndu = 
  sleep_df|> 
  filter(university == "NDU") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_ndu = 
  boot_straps_ndu |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'NDU')|> 
  filter(term != "(Intercept)")


boot_straps_uw = 
  sleep_df|> 
  filter(university == "UW") |> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result_uw = 
  boot_straps_uw |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(term = reorder(term, estimate),
         university = 'UW')|> 
  filter(term != "(Intercept)")


uni_coef = rbind(boot_result_cmu,
                 boot_result_ndu,
                 boot_result_uw) |> 
  mutate(university = factor(university, levels = c("CMU", "NDU", "UW"))) 

uni_coef |>
  ggplot(aes(x = term, y = estimate, color = university)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.7)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

```

`cum_gpa` is significant in all the university and `total_sleep_time` is still significant in NDU and UW. The impact of other variables shift between universities. More detailed result can be found on our page [Statistical Analysis](statistic_analysis.html).

---

## Discussion 

**Exploratory Analysis Findings:**

When exploring the student characteristics, we observed no significant differences in course load across various demographic groups, as measured by an independent t-test. However, we found both demographically underrepresented and first-generation groups are more likely to have lower GPA compared with their corresponding complement groups. Additionally, we found no significant relationship between the course load and GPA, no matter the relationship is overall or in a specific demographic sub-group. These finding answered Q1 and Q4 in *Initial Questions* portion.

As for sleeping pattern exploration, we found the *Total Sleep Time* and *Sleeping Midpoint* are roughly normally distributed while *Variability in Sleep Time* and *Daytime Sleep* are both very right skewed distributions. Besides, *Total Sleep Time* showed a positive relationship with *GPA* while  *Sleeping Midpoint* are detected to be negative related to *GPA*. These relationship align with the result of our regression models, supporting the conclusion of our later statistical analysis. This part answered Q2 and Q5 in *Initial Questions* portion.

**Statistical Analysis Findings**

According to the linear regression model result based on the pooled data, we conclude that the `total_sleep_time` has the most important impact on `term_gpa` among all the four sleeping measures. It has significant positive coefficient in both the sleeping measure only model and the the characteristic-included model, which implies having more sleep can potentially improve students' academic performance. Additionally, `midpoint_sleep` is significant negative related to `term_gpa`, indicating that sleeping earlier is helpful to get better GPA if given the same total sleep time. 

Besides, among the characteristic variables, `cum_gpa` is crucial to the `term_gpa`. And we also find the linear model shfits between universities, which means the impact of a specific predictors on the `term_gpa` varies from university to university.

Findings in statistical analysis part responded to Q3 and Q6 in *Initial Questions* portion.

**Suggestion**

Since the characteristic variable is usually fixed, students should focus on adjusting their sleeping patterns to improve their academic performance. 

Two useful suggestions we proposed based on our analysis are *sleep enough* and *sleep early*.





