---
title: "Demographics: Exploratory Analysis"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r include = FALSE,message=FALSE,warning=FALSE}
library(tidyverse)
library(gtsummary)
library(plotly)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

This page is designed to get an understanding of the characteristics (demographic and educational) of the 634 students who were included in this dataset. 
```{r,message=FALSE,warning=FALSE}
sleep_df <- read_csv("data/cmu-sleep.csv") |> 
  janitor::clean_names() |> 
  mutate(demo_race = case_when(demo_race == 0 ~ "Underrepresented", 
                                     demo_race == 1 ~ "Non-underpresented"),
         demo_race = fct_relevel(demo_race, "Underrepresented"),
         demo_gender = case_when(demo_gender == 0 ~ "Male", 
                                     demo_gender == 1 ~ "Female"),
         demo_gender = fct_relevel(demo_gender, "Male"), 
         demo_firstgen = case_when(demo_firstgen == "0" ~ "Non-first gen", 
                                   demo_firstgen == "1" ~ "First-gen", 
                                   TRUE ~ NA),
         demo_firstgen = fct_relevel(demo_firstgen, "Non-first gen"), 
         time_collection = case_when(cohort == "lac1" ~ "Spring, 2018", 
                            cohort == "lac2" ~ "Spring, 2017",
                            cohort == "nh" ~ "Spring, 2016",
                            cohort == "uw1" ~ "Spring, 2018", 
                            cohort == "uw2" ~ "Spring, 2019"), 
         cohort = case_when(cohort == "lac1" ~ "CMU", 
                            cohort == "lac2" ~ "CMU",
                            cohort == "nh" ~ "NDU",
                            cohort == "uw1" ~ "UW", 
                            cohort == "uw2" ~ "UW"))
```

```{css, echo = FALSE}
tr:hover {background-color: coral;}
th {
  height: 5px;
}
```

## Demographic Distribution of Observations
```{r, fig.width = 5, fig.height = 4, out.width = "90%", dpi=600,message=FALSE,warning=FALSE}
sleep_df <- sleep_df |> 
  rename(`Cohort` =`cohort`, 
         `Race` =`demo_race`, 
         `Gender` =`demo_gender`, 
         `First-Generation` =`demo_firstgen`, 
         `Relative Course Load`= `zterm_units_zof_z`, 
         `End-of-term GPA` =  `term_gpa`, 
         `Cumulative GPA` = `cum_gpa`)

#write_csv(sleep_df, "data/cleaned_cmu_sleep.csv")

summary_tbl <- sleep_df |> 
  select(`Cohort`, `Race`, `Gender`, `First-Generation`, time_collection,
         `Relative Course Load`, `End-of-term GPA`, `Cumulative GPA`) |> 
  tbl_summary(
    by = `Cohort`,
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})",
      all_categorical() ~ "{n} / {N} ({p}%)"), 
    label = list(
      time_collection ~ "Time")) |> 
  add_overall() |> 
  modify_spanning_header(c("stat_1", "stat_2", "stat_3") ~ "**Cohort**") |> 
  bold_labels() |>
  italicize_labels() |> 
  add_p()

as_kable_extra(summary_tbl)
```
</br>
The dataset consists of first-year students from three different kind universities: Carnegie Mellon (CMU) is a STEM-focused private university, University of Washington (UW) is a large public university and Notre Dame (NDU) is a private catholic university. Each cohort have students roughly 15-20% students with underrepresented racial identity. However, the male to female ratio, and proportion of first generation students vary between the cohorts. 

## Relative Course Load {.tabset}

```{r, dpi=600,message=FALSE,warning=FALSE}
plot_function <- function(demo) {
  plot <- sleep_df |> 
    drop_na(rlang::sym(demo)) |> 
    pivot_longer(
      cols = c(`Relative Course Load`, `End-of-term GPA`, `Cumulative GPA`), 
      names_to = "academic_info", 
      values_to = "unit"
    ) |> 
    mutate(academic_info = fct_relevel(academic_info, "Relative Course Load", "End-of-term GPA", "Cumulative GPA")) |> 
    ggplot(aes(x = get(demo), y = unit, fill = academic_info)) +
    geom_violin(alpha = 0.2) + 
    labs(y = "", x = "", fill = "") +
    scale_y_continuous(expand = c(0,0)) +
    facet_wrap(~academic_info, ncol = 3, scales = "free") +
    theme(panel.spacing = unit(1, "lines"), 
          axis.text.x = element_text(angle = 30))
  ggplotly(plot) |> 
    layout(autosize = F, width = 825, height = 350)

}
```

### Race {.tabset}

```{r}
demo_name = "Race"
plot_function(demo = demo_name)
```

### Gender {.tabset}

```{r}
demo_name = "Gender"
plot_function(demo = demo_name)
```

### First-Generation {.tabset}

```{r}
demo_name = "First-Generation"
plot_function(demo = demo_name)
```

### Cohort {.tabset}

```{r}
demo_name = "Cohort"
plot_function(demo = demo_name)
```

NDU does not have information related to term unit load. 

### Time of Data Collection {.tabset}

```{r}
demo_name = "time_collection"
plot_function(demo = demo_name)
```


