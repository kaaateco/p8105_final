---
title: "Statistic Analysis"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
library(tidyverse)
library(plotly)
library(ggplot2)
library(broom)
library(gtsummary)
library(knitr)
library(patchwork)
library(kableExtra)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

In this page, we use some typical statistic models to further explore the impact of students' sleeping patterns on their GPA. 

---

## Simple Linear Regression {.tabset}

To begin with, fit simple linear regression model to demonstrate the individual impact of each sleeping measure on students' GPA. Each time we use one sleeping measure as the predictor to predict the `term_gpa`.

Below are plots and statistics of the simple linear regression models. 


```{r, include=FALSE}
sleep_df <- read_csv("data/cmu-sleep.csv") %>% 
  janitor::clean_names() %>%  
  mutate(demo_race = case_when(demo_race == 0 ~ "Underrepresented", 
                                     demo_race == 1 ~ "Non-underrepresented"),
         demo_race = fct_relevel(demo_race, "Underrepresented"),
         demo_gender = case_when(demo_gender == 0 ~ "Male", 
                                     demo_gender == 1 ~ "Female"),
         demo_gender = fct_relevel(demo_gender, "Male"), 
         demo_firstgen = case_when(demo_firstgen == "0" ~ "Non-first gen", 
                                   demo_firstgen == "1" ~ "First-gen", 
                                   TRUE ~ NA),
         demo_firstgen = fct_relevel(demo_firstgen, "Non-first gen"), 
         time_collection = case_when(cohort == "lac1" ~ "Spring, 2018", 
                            cohort == "lac2" ~ "Spring, 2017",
                            cohort == "nh" ~ "Spring, 2016",
                            cohort == "uw1" ~ "Spring, 2018", 
                            cohort == "uw2" ~ "Spring, 2019"), 
         university = case_when(cohort == "lac1" ~ "CMU", 
                            cohort == "lac2" ~ "CMU",
                            cohort == "nh" ~ "NDU",
                            cohort == "uw1" ~ "UW", 
                            cohort == "uw2" ~ "UW"))

```



### Total Sleep Time {.tabset}

**Numerical Result**

```{r}
record_tab = data.frame(c())
lm_sp = lm(term_gpa ~ total_sleep_time, data = sleep_df)

tab_sp = lm_sp |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    conf_int = paste0("[",round(conf.low,6),", ",round(conf.high,6), "]"),
    estimate = round(estimate,6),
    std.error = round(std.error,6)) |> 
  select(-conf.low, -conf.high, -statistic) 


tab_sp|> 
  t() |> 
  kable(format = "html") |> 
  kable_styling(c("hover", "condensed"), full_width = FALSE) |> 
  column_spec(1, bold = TRUE, width = "3cm")

re_new = data.frame(`Single Predictor` = 'Total Sleep Time',
                    `P-value` = tab_sp$p.value[2],
                    MSE = mean(residuals(lm_sp)^2)
                    )
record_tab = rbind(record_tab, re_new)
```

**Model Visualization**

```{r}
plot_sp = 
  ggplot(data = sleep_df, aes(x = total_sleep_time, y = term_gpa)) +
  geom_point(color = "#664785", alpha = 0.5) +                      
  geom_smooth(method = "lm", se = TRUE, color = '#F2A354') +  
   geom_text(
    aes(label = paste0("MSE = ", round(mean(residuals(lm_sp)^2),6))),
    x = 500, y = 1,  
    hjust = 0, vjust = 0, size = 4, color = "#664785") +
  labs(  
    x = "Total Sleep Time (min)",
    y = "Term GPA",
    title = "Regressoin Plot"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(plot_sp)
```




--- 

### Variability in Bed Times {.tabset}

**Numerical Result**

```{r}
lm_sp = lm(term_gpa ~ bedtime_mssd, data = sleep_df)
tab_sp = lm_sp |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    conf_int = paste0("[",round(conf.low,6),", ",round(conf.high,6), "]"),
    estimate = round(estimate,6),
    std.error = round(std.error,6)) |> 
  select(-conf.low, -conf.high, -statistic) 


tab_sp|> 
  t() |> 
  kable(format = "html") |> 
  kable_styling(c("hover", "condensed"), full_width = FALSE) |> 
  column_spec(1, bold = TRUE, width = "3cm")

re_new = data.frame(`Single Predictor` = 'Variability in Bed Times',
                    `P-value` = tab_sp$p.value[2],
                    MSE = mean(residuals(lm_sp)^2)
                    )
record_tab = rbind(record_tab, re_new)
```

**Model Visualization**

```{r}
plot_sp = 
  ggplot(data = sleep_df, aes(x = bedtime_mssd, y = term_gpa)) +
  geom_point(color = "#664785", alpha = 0.5) +                      
  geom_smooth(method = "lm", se = TRUE, color = '#F2A354') +  
  geom_text(
   aes(label = paste0("MSE = ", round(mean(residuals(lm_sp)^2),6))),
   x = 15, y = 1,  
   hjust = 0, vjust = 0, size = 4, color = "#664785") +  
  labs(  
    x = "Mean Successive Squared Difference",
    y = "Term GPA",
    title = "Regressoin Plot"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(plot_sp)
```


--- 

### Sleeping Midpoint {.tabset}

**Numerical Result**

```{r}
lm_sp = lm(term_gpa ~ midpoint_sleep, data = sleep_df)

tab_sp = lm_sp |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    conf_int = paste0("[",round(conf.low,6),", ",round(conf.high,6), "]"),
    estimate = round(estimate,6),
    std.error = round(std.error,6)) |> 
  select(-conf.low, -conf.high, -statistic) 


tab_sp|> 
  t() |> 
  kable(format = "html") |> 
  kable_styling(c("hover", "condensed"), full_width = FALSE) |> 
  column_spec(1, bold = TRUE, width = "3cm")

re_new = data.frame(`Single Predictor` = 'Midpoint Sleep',
                    `P-value` = tab_sp$p.value[2],
                    MSE = mean(residuals(lm_sp)^2)
                    )
record_tab = rbind(record_tab, re_new)
```

**Model Visualization**

```{r}
plot_sp = 
  ggplot(data = sleep_df, aes(x = midpoint_sleep, y = term_gpa)) +
  geom_point(color = "#664785", alpha = 0.5) +                      
  geom_smooth(method = "lm", se = TRUE, color = '#F2A354') +  
  geom_text(
   aes(label = paste0("MSE = ", round(mean(residuals(lm_sp)^2),6))),
   x = 600, y = 1,  
   hjust = 0, vjust = 0, size = 4, color = "#664785") +  
  labs(  
    x = "Midpoint Sleep (minutes past 11 PM)",
    y = "Term GPA",
    title = "Regressoin Plot"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(plot_sp)
```



--- 

### Daytime Sleep {.tabset}

**Numerical Result**

```{r}
lm_sp = lm(term_gpa ~ daytime_sleep, data = sleep_df)

tab_sp = lm_sp |> 
  broom::tidy(conf.int = TRUE) |> 
  mutate(
    conf_int = paste0("[",round(conf.low,6),", ",round(conf.high,6), "]"),
    estimate = round(estimate,6),
    std.error = round(std.error,6)) |> 
  select(-conf.low, -conf.high, -statistic) 


tab_sp|> 
  t() |> 
  kable(format = "html") |> 
  kable_styling(c("hover", "condensed"), full_width = FALSE) |> 
  column_spec(1, bold = TRUE, width = "3cm")

re_new = data.frame(`Single Predictor` = 'Daytime Sleep',
                    `P-value` = tab_sp$p.value[2],
                    MSE = mean(residuals(lm_sp)^2)
                    )
record_tab = rbind(record_tab, re_new)

```


**Model Visualization**

```{r}
plot_sp = 
  ggplot(data = sleep_df, aes(x = daytime_sleep, y = term_gpa)) +
  geom_point(color = "#664785", alpha = 0.5) +                      
  geom_smooth(method = "lm", se = TRUE, color = '#F2A354') +  
  geom_text(
   aes(label = paste0("MSE = ", round(mean(residuals(lm_sp)^2),6))),
   x = 200, y = 1,  
   hjust = 0, vjust = 0, size = 4, color = "#664785") +  
  labs(  
    x = "Daytime Sleep (min)",
    y = "Term GPA",
    title = "Regressoin Plot"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5))

ggplotly(plot_sp)

```

---

 **COMMENTS:**
 
We collect the p-value and the Mean Squared Error from each simple linear regression model to the following table:


```{r}
record_tab|> 
  kable(format = "html") |> 
  kable_styling(c("hover", "condensed"), full_width = FALSE) |> 
  column_spec(1, bold = TRUE, width = "5cm")
```

Sleeping measure 'Total Sleep Time', 'Midpoint Sleep', and 'Daytime Sleep' have p-value less than 0.05, which means they have coefficient significantly not equal to 0. However, the measure 'Variability in Bed Times' has p-value larger than 0.05, implies this variable doesn't have significant impact on `term_gpa`.


## Multiple Linear Regression

Now consider including more variables to fit linear regression

### Sleeping Measures Only

Here use all the 4 sleeping measures as predictors to predict `term_gpa`.

```{r}
lm_fit = lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = sleep_df)

lm_result =
  broom::tidy(lm_fit,conf.int = TRUE) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(Method = 'Linear Regression')

boot_straps = 
  sleep_df|> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result = 
  boot_straps |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(Method = 'Bootstrap',
         estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high,Method)
  

com_coef =
  rbind(lm_result,boot_result) |> 
  filter(term != "(Intercept)") 

plot_coef = 
  com_coef |>   
  ggplot(aes(x = reorder(term, estimate), y = estimate, color = Method)) +
  geom_point(position = position_dodge(width = 0.3)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.3)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

plot_coef

```


**COMMENTS**

### Students' Characteristics and Sleeping Measures


```{r,fig.width= 6, fig.height=10 }
lm_fit = lm(term_gpa ~ university + demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = sleep_df)

lm_result =
  broom::tidy(lm_fit,conf.int = TRUE) |> 
  select(term, estimate, std.error, conf.low, conf.high) |> 
  mutate(Method = 'Linear Regression')

boot_straps = 
  sleep_df|> 
  modelr::bootstrap(1000) |> 
  mutate(
    strap = map(strap, as.tibble),
    models = map(strap, \(df) lm(term_gpa ~ university + demo_race + demo_gender + demo_firstgen + bedtime_mssd + total_sleep_time + midpoint_sleep + daytime_sleep + cum_gpa, data = df)),
    results = map(models, broom::tidy)
  ) |> 
  select(.id, results) |> 
  unnest(results)

boot_result = 
  boot_straps |> 
  group_by(term) |> 
  summarise(
    boot_est = mean(estimate),
    std.error = sd(estimate),
    conf.low = quantile(estimate, .025),
    conf.high = quantile(estimate, .975),
  ) |> 
  mutate(Method = 'Bootstrap',
         estimate = boot_est) |> 
  select(term, estimate, std.error, conf.low, conf.high,Method)
  

com_coef =
  rbind(lm_result,boot_result) |> 
  filter(term != "(Intercept)") 

plot_coef = 
  com_coef |>   
  ggplot(aes(x = reorder(term, estimate), y = estimate, color = Method)) +
  geom_point(position = position_dodge(width = 0.7)) +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), 
                width = 0.5, 
                position = position_dodge(width = 0.7)) +
  coord_flip() +
  labs(
    title = "Effect Sizes of Predictors on Cumulative GPA",
    x = "Predictors",
    y = "Coefficient Estimate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5),
        legend.position = "bottom")

plot_coef


```


**COMMENTS**







## University Specific Model


```{r,fig.width= 6, fig.height=10}
 ggplot(sleep_df, aes(x = total_sleep_time, y = cum_gpa)) +
  geom_point(alpha = 0.6, color = "#664785") +
  geom_smooth(method = "lm", se = FALSE, aes(color = university),alpha = 0.7) +
  labs(
    title = "Relationship Between Total Sleep Time and Cumulative GPA",
    x = "Total Sleep Time (Hours)",
    y = "Cumulative GPA"
  ) +
  theme_minimal()

```

